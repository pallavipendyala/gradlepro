on: [push]
name: Integrate Gradle project with Sonarqube and Github Actions
jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
        cache: gradle
    - name: Grant execute permission for gradlew
      run: |
            chmod +x gradlew
            ./gradlew build
    - name: sonar scan
      uses: sonarsource/sonarqube-scan-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      with:
        args: >
          -Dsonar.organization=pallavipendyala
          -Dsonar.projectKey=pallavipendyala_gradlepro
          -Dsonar.java.binaries=build/classes/
    - name: SonarQube Quality Gate check
      id: sonarqube-quality-gate-check
      uses: sonarsource/sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    - name: Download Fortify ScanCentral Client
      uses: fortify/gha-setup-scancentral-client@v1
    - name: Package Code + Dependencies
      run: scancentral package $PACKAGE_OPTS -o package.zip
      env:
        PACKAGE_OPTS: "-bc gradle build"
    - uses: jfrog/setup-jfrog-cli@v2
      env:
        # JFrog platform url (for example: https://acme.jfrog.io) 
        JF_URL: ${{ secrets.JF_URL }}
        JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      
    - run: |
          jf rt ping 
          jf rt u "build/libs/(*.jar)" example-repo-local/{1} --sync-deletes="example-repo-local/"


